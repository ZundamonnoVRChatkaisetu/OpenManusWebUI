# OpenManus Web UI 実装計画

## 実装項目概要

1. ✅ **プロジェクト管理機能の修正**（2025-03-19）
   - プロジェクト管理機能のインターフェース統合
   - ES6モジュール化と機能拡張
   - セッション管理との連携強化

2. ✅ **プロジェクトごとのワークスペースファイル管理**（2025-03-19）
   - プロジェクト専用ディレクトリ構造
   - API側のファイル取得拡張
   - フロントエンドとの連携

3. ✅ **Claudeライクなプロジェクト・チャット管理**（2025-03-19）
   - チャット履歴の保存と表示
   - セッション切り替え機能
   - インターフェース改良

4. ✅ **プロジェクト指示保持と削除・名前変更機能**（2025-03-20）
   - 内部状態管理の強化
   - 削除・名前変更機能の実装
   - UI改良

5. ✅ **LMStudioサーバーの自動起動機能**（2025-03-20）
   - 複数OS対応
   - コマンドラインオプション拡張
   - プロセス管理

6. ✅ **LMStudioサーバー起動時のエンコーディング問題修正**（2025-03-20）
   - バイナリモードとUTF-8デコード
   - エラーハンドリング強化

7. ✅ **LLMAPIリクエストのタイムアウト改善**（2025-03-20）
   - タイムアウト時間延長
   - ログ出力強化
   - LM Studio設定最適化

8. ✅ **Claude MCPライクなツール連携機能**（2025-03-20）
   - ツール基本クラスとマネージャー
   - GitHub連携ツール
   - Web検索ツール
   - 設定UIの改善

9. ✅ **GitHub・Web検索API連携問題の修正**（2025-03-20）
   - 認証処理の改善
   - Brave Search API対応
   - 診断機能強化

10. ✅ **GitHub検証エンドポイントのHTTPメソッド修正**（2025-03-20）
    - GETメソッド対応
    - 共通処理化
    - Web検索ツール検証

11. ✅ **ログ出力の最適化とフィルタリング**（2025-03-20）
    - LogFilterMiddleware実装
    - フィルタリング対象設定
    - ログ形式最適化

12. ✅ **ツール設定の永続化問題の修正**（2025-03-20）
    - クロスプラットフォーム対応
    - パーミッション管理
    - デバッグ機能強化

13. ✅ **モデル処理中の追加指示機能の実装**（2025-03-20）
    - 送信ボタンの常時有効化
    - メッセージキューイング
    - UI/UX改善

14. ✅ **WebSocket接続時のログ出力抑制**（2025-03-21）
    - ログフィルタリング強化
    - ログレベル設定オプション
    - ファイルパスフィルタリング

15. ✅ **言語対応と出力最適化機能の実装**（2025-03-21）
    - 言語検出と多言語対応
    - 出力フォーマット最適化
    - ファイル生成機能強化
    - EnhancedManusクラス実装

16. ✅ **正規表現パターンのSyntaxError修正**（2025-03-21）
    - 問題の特定と分析
    - 正規表現パターン修正
    - ファクトリー連携

17. ✅ **タイムアウト時間と実行ステップ数の拡張**（2025-03-21）
    - タイムアウト値の300秒への延長
    - 実行ステップ数の増加
    - ロギング改善

18. ✅ **モデル思考プロセスと操作状況の可視化機能の実装**（2025-03-21）
    - 思考プロセス表示機能
    - 操作状況の視覺化
    - デザイン調整

19. ✅ **Manus風のUIデザイン実装**（2025-03-21）
    - CSSの作成
    - HTMLテンプレート刷新
    - 視覺化コンポーネント実装
    - UI切り替え機能

20. ✅ **UIが更新されない問題の修正**（2025-03-21）
    - テンプレート処理の修正
    - CSSとJavaScriptファイルの作成
    - app.pyの修正

21. ✅ **ブラウザーツールのクロスプラットフォーム対応**（2025-03-21）
    - Windows環境のPlaywrightエラー対応
    - 代替実装メカニズムの追加
    - 複数ブラウザバックエンド対応
    - エラーハンドリング強化

22. ✅ **処理中の追加指示機能の改良**（2025-03-21）
    - LLMCommunicationTrackerの処理強化
    - 追加指示の確実な反映
    - 思考ステップでの追加指示の詳細表示
    - エラーハンドリング強化

23. ✅ **Microsoft Store版Python環境でのブラウザツール対応**（2025-03-21）
    - Microsoft Store版Pythonの検出
    - NotImplementedError対策の実装
    - Selenium WebDriverによるフォールバック機能の追加
    - 複数ブラウザ環境への対応強化

24. ✅ **Windows環境でのブラウザツール互換性拡張**（2025-03-21）
    - Windows環境に最適化されたブラウザバックエンド選択
    - Playwrightの無効化とSeleniumへの自動切り替え
    - venv/Storeバージョン混在環境への対応
    - 環境判定ロジックの強化と安定性向上

25. ✅ **Windows環境でのPlaywright完全無効化対応**（2025-03-21）
    - モジュールインポート時点でのPlaywright無効化
    - 実行時の複数レイヤーでのバックエンド検証
    - Seleniumへの確実なフォールバック保証
    - 動的モジュール検出による互換性向上

26. ✅ **ブラウザツールのシンタックスエラー修正**（2025-03-21）
    - グローバル変数宣言位置の修正
    - Python構文規則の遵守
    - 実行時例外処理の改善
    - モジュール間の依存関係整理

27. ✅ **ブラウザツールのモジュール分割とリファクタリング**（2025-03-21）
    - ブラウザバックエンドの分割
    - コンポーネント化とテスト性向上
    - Windows環境でのasyncio完全無効化
    - 実装コードの簡素化

28. ✅ **LLMコンテキスト長制限の拡張**（2025-03-21）
    - コンテキスト長の4096から8192への増加
    - 設定ファイルの更新（config.pyとconfig.example.toml）
    - 一貫性保持のためのデフォルト値調整
    - エラーハンドリングの強化

29. ✅ **EnhancedManusクラスのツール呼び出し修正**（2025-03-21）
    - PythonExecuteツールへの言語パラメータ渡し修正
    - ツール実行時の不要なパラメータ削除
    - 言語関連機能とツール実行の分離
    - 安全なパラメータ処理の実装

30. ✅ **ブラウザツールの非同期クリーンアップ問題の修正**（2025-03-21）
    - イベントループ実行中の非同期クリーンアップ処理の改善
    - `__del__`メソッドの再実装とエラーハンドリング強化
    - RuntimeErrorの適切な処理
    - 非同期リソース管理の最適化

31. ✅ **プラットフォーム検出処理のsubprocess依存の解消**（2025-03-21）
    - Microsoft Store版Python検出ロジックの改善
    - subprocessモジュール使用の排除
    - パスベースの安全な環境検出実装
    - モジュール検出機能の強化

32. ✅ **ワークスペースとファイル操作機能の強化**（2025-03-21）
    - プロジェクトごとのワークスペース管理
    - ファイル保存・読み込み・一覧機能の実装
    - 安全なワークスペースパス解決
    - プロジェクト情報の出力フォーマット改善
    - データタイプに基づいたファイル表示の最適化

33. ✅ **LMStudio会話ロールエラーの修正**（2025-03-21）
    - 「Conversation roles must alternate」エラー対応
    - Memory.add_message機能の拡張による連続ロール防止
    - 同じロールが連続する場合の自動マージ機能
    - 会話ロールの交互配置保証メカニズム

34. ✅ **エージェント精度低下対策の実装**（2025-03-21）
    - 進捗を管理するファイルを作成させるようにし、それを次のステップに行くたびに参照し、現在の進捗を理解できるようにする
    - 進捗を管理するファイル内のタスクが完了したら、そのタスクに完了したことがわかるように記載し、次のタスクの実施に移る
    - 完了した場合の記載は、完了マーク・どのファイルをどのディレクトリに作成したか・ディレクトリ構成とファイルの役割などを理解しやすい形で記載する

35. ✅ **追加指示機能の通信問題修正**（2025-03-21）
    - LLMCommunicationTrackerクラスの完全リファクタリング
    - ask_toolメソッドのモンキーパッチ機能強化
    - 追加指示の適切な統合メカニズム実装
    - WebSocketへのリアルタイム通知改善
    - 思考ステップへの指示反映ステータス追加
    - 追加指示をユーザーメッセージとして適切に追加

36. ✅ **Agent importエラーの修正**（2025-03-21）
    - app.agent.base から Agent クラスをインポートできないエラーの修正
    - enhanced_agent_factory.py ファイルのインポート文を修正
    - `from app.agent.base import Agent` を `from app.agent.base import BaseAgent as Agent` に変更
    - モジュール間の一貫性を保持

37. ✅ **Manasviモジュール未対応エラーの修正**（2025-03-21）
    - enhanced_agent_factory.py から存在しないManasviモジュールへの参照を削除
    - 不要な `create_manasvi_agent` 関数を削除
    - `from app.agent.manasvi import Manasvi` インポート文の削除
    - コードの無駄を排除し、必要な機能のみ残す

38. ✅ **ブラウザツールの依存パッケージ対応**（2025-03-21）
    - Seleniumパッケージがない場合のエラーメッセージの強化
    - パッケージのインストール手順をログに表示
    - Windows環境で必要なモジュールの判定処理改善
    - バックエンド選択時の入力チェック強化
    - モジュール検出機能とインストールガイド機能の追加
    - エラー処理の改善と適切なフォールバック

39. 🔄 **ChatGPT風UIとファイル表示機能の強化**（2025-03-22）
    - ChatGPTを参考にしたUIデザインの変更
    - AI思考プロセス表示UIの改良
    - モデルが作成したファイルを表示するためのUI追加
    - ファイル内容の表示・複製機能の強化
    - WebSocket通信でのファイル生成情報伝達機能の実装
    - ユーザビリティの向上とレスポンシブデザインの改善
    - デザイン構成を再調整して使いやすさを向上
    - モデル生成ファイルの保存処理修正

## ディレクトリ構成と主要ファイルの役割

### プロジェクト構造

```
OpenManusWebUI/
├─ app/                          # メインアプリケーション
│   ├─ agent/                    # AIエージェント
│   ├─ flow/                     # プロンプトフロー
│   ├─ llm/                      # 言語モデル通信
│   ├─ tool/                     # ツール機能
│   │   ├─ browser_backends/     # ブラウザバックエンド
│   │   │   ├─ __init__.py       # 初期化
│   │   │   ├─ asyncio_patch.py  # Windows環境対応
│   │   │   ├─ backend_manager.py # バックエンド管理
│   │   │   └─ platform_detector.py # 実行環境検出
│   │   ├─ base.py              # 基本ツールクラス
│   │   ├─ file_saver.py         # ファイル操作ツール
│   │   └─ browser_use_tool.py   # ブラウザ操作ツール
│   ├─ utils/                    # ユーティリティ
│   │   ├─ language_utils.py     # 言語検出と多言語処理
│   │   └─ output_formatter.py   # 出力フォーマット
│   └─ web/                      # Webインターフェース
│       ├─ static/               # 静的ファイル
│       │   ├─ css/              # スタイルシート
│       │   │   ├─ visualizers.css   # 視覚化コンポーネントのスタイル
│       │   │   └─ generated_files.css # 生成ファイル表示スタイル
│       │   ├─ js/               # JavaScriptファイル
│       │   │   ├─ thinking_process_visualizer.js  # 思考プロセス視覚化
│       │   │   ├─ tool_usage_visualizer.js        # ツール使用状況視覚化
│       │   │   ├─ model_visualization_controller.js # 視覚化コントローラー
│       │   │   └─ generated_files_viewer.js       # 生成ファイル表示
│       │   └─ images/           # 画像
│       ├─ templates/            # HTMLテンプレート
│       └─ tools/                # ツール連携
├─ logs/                         # ログファイル
├─ workspace/                    # 共通ワークスペース
├─ project_workspace/            # プロジェクト別ワークスペース
└─ web_run.py                    # サーバー起動スクリプト
```

### 主要ファイルの役割

#### 起動とサーバー制御
- **web_run.py**: Webサーバーと必要に応じてLMStudioサーバーを起動

#### Webアプリケーション
- **app/web/app.py**: FastAPIアプリケーション（エンドポイント、WebSocket）
- **app/web/database.py**: データベース操作（SQLite）
- **app/web/models.py**: データモデル定義

#### フロントエンド
- **app/web/templates/connected_interface.html**: メインUI
- **app/web/static/connected_interface.js**: フロントエンドロジック
- **app/web/static/style.css**: 基本スタイル
- **app/web/static/css/visualizers.css**: 思考プロセス視覚化スタイル
- **app/web/static/css/generated_files.css**: 生成ファイル表示スタイル
- **app/web/static/js/**: 視覚化コンポーネント各種
- **app/web/static/js/generated_files_viewer.js**: 生成ファイル表示コンポーネント

#### 機能モジュール
- **app/web/project_manager.js**: プロジェクト管理
- **app/web/connected_chatManager.js**: チャット管理
- **app/web/connected_workspaceManager.js**: ファイル管理

#### AIエージェント
- **app/agent/enhanced_manus.py**: 強化版AIエージェント
- **app/agent/base.py**: エージェント基本クラス（精度維持機能を含む）
- **app/agent/toolcall.py**: ツール呼び出し機能とプロセス最適化
- **app/web/enhanced_agent_factory.py**: エージェント生成

#### ツール連携
- **app/web/tools/routes.py**: ツールAPI
- **app/web/tools/tool_manager.py**: ツール管理
- **app/web/tools/github_tool.py**: GitHub連携
- **app/web/tools/web_search_tool.py**: Web検索
- **app/tool/browser_use_tool.py**: クロスプラットフォーム対応ブラウザツール
- **app/tool/file_saver.py**: ワークスペース対応ファイル操作
- **app/tool/browser_backends/**: ブラウザ操作のバックエンド実装

#### ユーティリティ
- **app/utils/language_utils.py**: 言語検出
- **app/utils/output_formatter.py**: 出力フォーマット
- **app/web/thinking_tracker.py**: 思考プロセス管理
- **app/web/logging_config.py**: ログ設定
- **app/config.py**: アプリケーション設定とワークスペース管理
- **app/schema.py**: データモデルとメッセージ処理（会話履歴最適化機能を含む）

### 機能フロー概要

1. **チャット処理**: ユーザー入力 → API → エージェント → LLM → 結果表示
2. **プロジェクト管理**: UI操作 → API → データベース → UI更新
3. **ツール実行**: AIツール呼出 → ツール実行 → 結果処理 → UI表示
4. **追加指示処理**: ユーザー入力 → API → 処理中タスクに追加 → LLM追加処理 → 結果統合
5. **環境検出**: 実行環境検出 → 最適なバックエンド選択 → 機能提供
6. **環境適応**: OSタイプ検出 → プラットフォーム固有の最適化 → 適切なバックエンド強制
7. **ファイル操作**: ユーザー指示 → ワークスペースパス解決 → ファイル処理 → 結果フォーマット
8. **会話管理**: ユーザーメッセージ → メモリー追加 → ロール最適化 → LLM入力形成
9. **精度維持**: 会話履歴監視 → 長さ/複雑さ分析 → 自動要約/最適化 → 進捗モニタリング → 戦略調整
10. **指示追加**: 追加指示 → WebSocket通知 → バックエンド保存 → LLM通信時に統合 → ステータス更新
11. **生成ファイル表示**: モデルファイル生成 → WebSocket通知 → UI表示 → ファイル操作

この構造により、UIの変更と機能追加が適切に分離され、コンポーネント間の責任範囲が明確になっています。テンプレートシステムの適切な使用により、UIの見た目と動作ロジックが分離され、保守性が向上しています。また、複数の環境に対応する柔軟な実装により、異なるPython環境でも安定して動作するようになっています。Python構文規則の厳密な遵守により、異なるPythonバージョン間での互換性も確保されています。ワークスペース管理機能の追加により、プロジェクトごとのファイル分離と管理が可能になりました。会話ロール最適化機能によるLM Studio APIとの互換性向上と、精度低下対策メカニズムによる長時間の実行でも品質を維持する機能が実装されました。追加指示機能の通信フローを完全に修正し、処理中のモデルに確実に反映されるようになりました。モデルが生成したファイルの管理と表示機能を追加し、ユーザビリティが向上しました。
